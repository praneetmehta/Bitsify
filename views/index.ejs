<!DOCTYPE html>
<html>
<head>
	<title>Bitsify</title>
	<script type="text/javascript" src="/js/jquery-3.2.1.min.js"></script>
	<script type="text/javascript" src="/js/materialize.min.js"></script>
	<link rel="stylesheet" type="text/css" href="/css/materialize.min.css">
	<link rel="stylesheet" type="text/css" href="/css/style.css">
	<link href="/css/fonts.css" type="text/css" rel="stylesheet">
	<script type="text/javascript" src="/js/ejs_production.js"></script>
</head>
<body>
	<div id="background">
		<img id="bg_img" src="/images/bg.png">
	</div>
	<div id="warning-message" style="position: fixed;width: 100%;height: 100%;">
		<h1 style="position: fixed;" id="warning_text">Plese rotate your device</h1><br>
		<i  style="position: fixed" class="material-icons large" id="warning_icon">stay_primary_landscape</i>
	</div>
	<div id="music_player">

		<div id="nav_flex_container">
		<form id="search_form">
			<input type="text" name="search" id="search_song" placeholder="search songs" autocomplete="off">
			<input type="submit" style="position: absolute; left: -9999px"/>


		</form>
		<div id="search_results"></div>
		</div>
		<div id="window">
			<% include ./table %>
		</div>
		<div id="controls_flex_container">
			<div id="song_info">
				<div id="art_holder">
					<img id="art_now_playing" src="/images/none.png" alt="x"> 
				</div>
				<div id="info_holder">
					<h6 id="title_now_playing"><strong><%= list[0].title%></strong></h6>
					<h6 id="album_now_playing"><%= list[0].album%></h6>
				</div>
			</div>
			<div id="controls">
				<div id="playback_buttons">
					<audio preload="none" id="audio_player">
						<source id="song_source" src="<%= list[0].path%>">
					</audio>
					<i class="small material-icons" id="replay" style="font-size: 22px;">replay_30</i>
					<i class="small material-icons" id="previous" style="font-size: 22px;">skip_previous</i>
					<i class="small material-icons" id="play">play_circle_outline</i>
					<i class="small material-icons" id="next" style="font-size: 22px;">skip_next</i>
					<i class="small material-icons" id="forward" style="font-size: 22px;">forward_30</i>
				</div>
				<div id="slider">
					<h6 id="timeNow"><span>00</span>:<span>00</span></h6>
					<div id='progress'>
		      			<div id='progress-bar'></div>
		    		</div>
		    		<h6 id="length"><span>00</span>:<span>00</span></h6>	
				</div>
			</div>
			<div id="other_controls">
				
			</div>
		</div>
		<div id="user_flex_container">
			<h6 style="padding:15px">Praneet's Songs</h6>
		</div>
	</div>

	<script src="/js/playerControls.js"></script>
	<script src="/js/fileReader.js"></script>
	<script src="/js/id3-minimized.js"></script>
<!-- 	<script src="/js/id3extractor.js" ></script>
 -->	<script>
	$(document).ready(function(){
		window.nextSong = '';
		window.prevSong = '';
		$("#search_form").submit(function(e) {
		    return false;
		});
		$('#next').click(function(){
			var player = $('audio')[0];

			var ele = window.nextSong;
			console.log(ele)
			selfClick = true;
			player.pause();
			var waitTime = 150;

			var nextSongtoPlay = ele.find('td').first().find('span');
			console.log(nextSongtoPlay.html());
			setTimeout(function () {      
			  // Resume play if the element if is paused
			    nextSongtoPlay.click();
			    console.log('ck');
			  
			}, waitTime);
			
		});
		$('#previous').click(function(){
			var player = $('audio')[0];

			var ele = window.prevSong;
			selfClick = true;
			player.pause();
			var waitTime = 150
			var nextSongtoPlay = ele.find('td').first().find('span');
			setTimeout(function () {      
			  // Resume play if the element if is paused
			    nextSongtoPlay.click();
			    console.log('ck');
			  
			}, waitTime);
			
		});
		var player = $('audio')[0];
		$(player).on('ended', function(){
			var ele = window.nextSong;
			selfClick = true;
			player.pause();
			var waitTime = 150
			var nextSongtoPlay = ele.find('td').first().find('span');
			setTimeout(function () {      
			  // Resume play if the element if is paused
			    nextSongtoPlay.click();
			    console.log('ck');
			  
			}, waitTime);
		});
		// $('#search_song').change(function(){
		// 	searchSong();
		// })
		$('#search_song').on('keyup', function() {
		    var val1 = $('#search_song').val();
		    setTimeout(function(){
		    	if($('#search_song').val() == val1 && $('#search_song').val() != ''){
		    		searchSong();
		    	}else if(val1 == ''){
		    		renderSearchResult([], 'nothingFound')
		    	}
		    },800);

		});
		$('#art_now_playing').attr('src',"data:image/jpeg;base64,<%= list[0].image%>");
		var e =document.getElementById('art_now_playing');
		var h = $('#controls_flex_container').height()-10;
		var w = $(window).width();
		e.style.width = h+'px';
		e.style.height = h+'px';
		e.style.bottom = h*.08 + 'px';
		$('#slider').css({
			'marginBottom':h*.15+'px'
		});
		console.log(w*.05);
		$('#title_now_playing').css({
			'marginLeft':w*.02+'px'
		});
		$('#album_now_playing').css({
			'margin-left':w*.02+'px'
		});
		$(window).resize(function () 
		{
		    var width = $(window).width();
		    var height = $(window).height() - $("#controls_flex_container").height()-20;
		    $('#window').css({
		    	'width':width*.727 + 'px',
		    	'height': height+'px',
		    	'left': width*.14 + 'px'

		    });
		    setTimeout(function(){
		    	var e =document.getElementById('art_now_playing');
		    	var h = $('#controls_flex_container').height()-10;
		    	var w = $(window).width();
		    	e.style.width = h+'px';
		    	e.style.height = h+'px';
		    	e.style.bottom = h*.08 + 'px';
		    	$('#slider').css({
		    		'marginBottom':h*.15+'px'
		    	});
				var w1 = $('#warning_text').width();
		        var w2 = $(window).width();
		        var w3 = $('#warning_icon').width();
				$('#warning_text').css({'position': 'fixed','top': ($(window).height())/2.5 +'px','left': (w2-w1)/2+'px'});
				$('#warning_icon').css({'position': 'fixed','top': ($(window).height())/2.1 +'px','left': (w2-w3)/2+'px'});
				console.log(w*.05);
				$('#title_now_playing').css({
					'margin-left':w*.02+'px'
				});
				$('#album_now_playing').css({
					'margin-left':w*.02+'px'
				});
		    },500);
		});
		var w1 = $('#warning_text').width();
        var w2 = $(window).width();
        var w3 = $('#warning_icon').width();
		$('#warning_text').css({'position': 'fixed','top': ($(window).height())/2.5 +'px','left': (w2-w1)/2+'px'});
		$('#warning_icon').css({'position': 'fixed','top': ($(window).height())/2.1 +'px','left': (w2-w3)/2+'px'});
		console.log(w1);
		// $('#nav_flex_container').resizable({
		//     handles: 'n,w,s,e',
		//     minWidth: 200,
		//     maxWidth: 300
		// });
		var width = $(window).width();
		var height = $(window).height() - $("#controls_flex_container").height()-20;
		$('#window').css({
			'width':width*.727 + 'px',
			'height': height+'px',
			'left': width*.14 + 'px'
		});
		var obj = document.getElementsByClassName('list_span');
		[].forEach.call(document.getElementsByClassName('list_span'),function(ele){
			ele.addEventListener('click', function(){
				elej = $(ele);
				window.nextSong = $(ele).closest('tr').next('tr');
				window.prevSong = $(ele).closest('tr').prev('tr');
				//nextSong($(ele).closest('tr').next('tr'));
				//previousSong($(ele).closest('tr').prev('tr'))
				// console.log(ele.parentNode.parentNode.rows);
				songChange(ele.innerHTML.split('<span>')[0]);
			});
		});
		function songChange(song){
			$.ajax({
			        type: "POST",
			        url: "/",
			        data: JSON.stringify({song:song}),
			        contentType: "application/json; charset=utf-8",
			        dataType: "json",
			        success: function(data){
			        	if(data[0].status == 'OK'){
			        		// console.log(typeof(data[1]));
			        		 console.log(data[1]);
			        		$('#title_now_playing').html(data[1].title);
			        		$('#album_now_playing').html(data[1].album.split('(')[0].slice(0,28));
			        		$('#art_now_playing').attr('src',"data:image/jpeg;base64," + data[1].image);
			        		$('#song_source').attr('src', data[1].path);
			        		document.getElementById("audio_player").load();
			        		setTimeout(function(){
			        			$('audio')[0].play();
			        			$('#play').html('pause_circle_outline');
			        		},300);
			        	}else{
			        		alert('failed');
			        	}
			        },
			        failure: function(errMsg) {
			            alert(errMsg);
			        }
			  });
		}
		function refresh(){
			$.ajax({
			        type: "POST",
			        url: "/refresh",
			        data: JSON.stringify({task:refresh}),
			        contentType: "application/json; charset=utf-8",
			        dataType: "json",
			        success: function(data){
			        	if(data[0].status == 'OK'){
			        		// console.log(typeof(data[1]));
			        		console.log(data[1]);
			        		
			        	}else{
			        		alert('failed');
			        	}
			        },
			        failure: function(errMsg) {
			            alert(errMsg);
			        }
			  });
		}

		var e =document.getElementById('art_now_playing');
		e.addEventListener('click', function(){
			console.log('clicked');
			w = $('#nav_flex_container').width()-10;
			h = $('#controls_flex_container').height()-10;
			if(e.style.width == w+'px'){
				e.style.transition = "all 0.5s";
				e.style.width = h+'px';
				e.style.height = h+'px';
				e.style.bottom = '8px';
				e.style.transform = 'rotateY(180deg)';
				$('#art_holder').css({"width":"50px"});
				setTimeout(function(){
					e.style.transition = "all 0.01s";
					e.style.transform = 'rotateY(0deg)';
				},190);
				$('#art_holder').css({"width":"50px"});

			}else{
				e.style.transition = "all 0.5s";
				e.style.width = w+'px';
				e.style.height = w+'px';
				e.style.position = 'fixed';
				e.style.bottom = '10%';
				e.style.transform = 'rotateY(180deg)';
				setTimeout(function(){
					e.style.transition = "all 0.01s";
					e.style.transform = 'rotateY(0deg)';
				},190);
				$('#art_holder').css({"width":"0px"});
			}
		});

		function searchSong(){
			var song = $('#search_song').val();
			console.log(song);
			$.ajax({
				type: "POST",
				url: '/search',
				data: JSON.stringify({search_song: song}),
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				success: function(data){
					if(data.length == 0){
						// console.log(typeof(data[1]));
						renderSearchResult([{title:'Nothing Found', artist:''}], 'nothingFound');
					}else{
						// var html = new EJS({url: '/table.ejs'}).render(data)
						// console.log(html);
						renderSearchResult(data, 'search_result_list');
					}
				},
				failure: function(errMsg) {
				    alert(errMsg);
				}

			});
		}

		function renderSearchResult(data, classtoadd){
			html = '<ul>';
			for(var i=0;i<data.length;i++){
				html += '<li style="font-size:12px;color:white;padding:5px 2px 5px 10px;background:rgba(255,255,255,.06);font-weight:100;" class="'+classtoadd+'"><strong>'+data[i].title+'</strong><br><span style="font-size:10px">'+data[i].artist+'</span><br><span style="font-size:10px">'+data[i].album+'</span></li><br>'
			}
			html+='</ul>';
			$('#search_results').html(html);
			attachListeners();
		}

		function attachListeners(){
			[].forEach.call(document.getElementsByClassName('search_result_list'),function(ele){
				ele.addEventListener('click', function(){
					ele.style.cursor = 'pointer';
					console.log(ele.innerHTML.split('>')[1].split('<')[0]);
					songChange(ele.innerHTML.split('>')[1].split('<')[0]);
				});
			});
		}

		// function nextSong(ele){
		// 	var player = $('audio')[0];
		// 	var selfClick = false;
		// 	$(player).on('ended', function(){ 
		// 	    player.pause();
		// 	    var waitTime = 150
		// 	    player.currentTime = 0;
		// 	    var nextSongtoPlay = ele.find('td').first().find('span');
		// 	    setTimeout(function () {      
		// 	      // Resume play if the element if is paused
		// 	        if(!selfClick){
		// 	        	console.log('clicked');
		// 	        	nextSongtoPlay.click();
		// 	        }
			      
		// 	    }, waitTime);
			    
		// 	});
		// 	// $('#next').click(function(){
		// 	// 	selfClick = true;
		// 	// 	player.pause();
		// 	// 	var waitTime = 150
		// 	// 	player.currentTime = 0;
		// 	// 	var nextSongtoPlay = ele.find('td').first().find('span');
		// 	// 	setTimeout(function () {      
		// 	// 	  // Resume play if the element if is paused
		// 	// 	    nextSongtoPlay.click();
		// 	// 	    console.log('ck');
				  
		// 	// 	}, waitTime);
				
		// 	// });

		// }
		// function previousSong(ele){
		// 	var player = $('audio')[0]

		// 	$('#previous').click(function(){
		// 		player.pause();
		// 		var waitTime = 150
		// 		player.currentTime = 0;
		// 		var preSongToPlay = ele.find('td').first().find('span');
		// 		setTimeout(function () {      
		// 		  // Resume play if the element if is paused
		// 			if(preSongToPlay){
		// 				preSongToPlay.click();
		// 			}else{
		// 				console.log('last song');
		// 			}				  
		// 		}, waitTime);
				
		// 	});
		// }
	});



	</script>
	<style type="text/css">
	    #warning-message { display: none; }
	    @media only screen and (orientation:portrait){
	        #music_player { display:none; }
	        #warning-message { display:block; }
	    }
	    @media only screen and (orientation:landscape){
	        #warning-message { display:none; }
	    }
	    .search_result_list:hover{
	    	cursor: pointer;
	    }
	</style>
</body>

</html>

